<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Waiter POS</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
  :root{--primary:#0062ca;--green:#28a745;--muted:#f4f4f4;}
  body{font-family:Segoe UI,sans-serif;background:var(--muted);padding:18px;display:flex;flex-direction:column;align-items:center;gap:12px;}
  .order-box{background:var(--primary);padding:18px;border-radius:12px;color:#fff;width:380px;box-shadow:0 8px 24px rgba(0,0,0,.12);}
  .order-box h2{margin:0 0 10px;font-size:18px;text-align:center;}
  input,select{width:100%;padding:9px;margin:6px 0;border-radius:8px;border:none;font-size:15px;outline:none;}
  .add-btn{background:var(--green);color:#fff;border-radius:8px;padding:10px;font-weight:700;cursor:pointer;border:none;}
  .tables-container{display:flex;flex-wrap:wrap;gap:14px;justify-content:center;width:100%;}
  .table-box{background:#fff;padding:12px;border-radius:12px;width:340px;box-shadow:0 8px 20px rgba(0,0,0,.12);max-height:640px;overflow:auto;}
  .table-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
  .table-total{font-weight:700;}
  .person-box{background:#f0f0f0;padding:8px;border-radius:10px;margin-bottom:8px;}
  .person-actions{display:flex;gap:6px;margin-top:6px;flex-wrap:wrap;}
  .item-box{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;margin:6px 0;background:#fff;}
  .pending{background:#fff7e6;}
  .served{background:#e9f7ee;}
  button.small{padding:6px 8px;border-radius:8px;border:none;cursor:pointer;}
  .served-btn{background:var(--green);color:#fff;}
  .cancel-btn{background:#dc3545;color:#fff;}
  .merge-btn{background:#007bff;color:#fff;}
  .split-btn{background:#ffc107;color:#222;}
  .move-select{padding:6px;border-radius:6px;}
  .payment-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:flex;justify-content:center;align-items:center;z-index:100;display:none;}
  .payment-box{background:#fff;padding:20px;border-radius:12px;width:350px;max-height:80%;overflow:auto;}
  .payment-box h3{margin-top:0;}
  .payment-method{margin:6px 0;}
</style>
</head>
<body>

<div class="order-box">
  <h2><i class="fas fa-utensils"></i> Waiter POS</h2>

  <label>Table</label>
  <select id="tableSelect"><option value="" disabled selected>Select table</option></select>

  <label>Description (person / note)</label>
  <input id="description" placeholder="e.g. John / Veggie" />

  <label>Type</label>
  <select id="typeSelect"><option value="" disabled selected>Select type</option><option value="food">Food</option><option value="drink">Drink</option></select>

  <label>Item</label>
  <select id="itemSelect"><option value="" disabled selected>Select item</option></select>

  <label>Quantity</label>
  <input id="quantity" type="number" min="1" value="1" />

  <button id="addItemBtn" class="add-btn"><i class="fas fa-plus"></i> Add Item</button>
</div>

<div id="tablesContainer" class="tables-container"></div>

<!-- Payment overlay -->
<div id="paymentOverlay" class="payment-overlay">
  <div class="payment-box">
    <h3>Payment</h3>
    <div id="paymentContent"></div>
    <label>Payment Method</label>
    <select id="paymentMethod">
      <option value="" disabled selected>Select method</option>
      <option value="cash">Cash</option>
      <option value="card">Card</option>
      <option value="mobile">Mobile</option>
    </select>
    <button id="paidBtn" class="add-btn" style="margin-top:10px;">Paid</button>
    <button id="closePayment" class="add-btn" style="background:#dc3545;margin-top:10px;">Close</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyC6VdctOXcT-qHaLJs1gEzwzVv5AdK5e0w",
  authDomain: "pos-system-9a056.firebaseapp.com",
  projectId: "pos-system-9a056",
  storageBucket: "pos-system-9a056.firebasestorage.app",
  messagingSenderId: "701001104012",
  appId: "1:701001104012:web:294967faec11a627c819a9"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// UI elements
const tableSelect = document.getElementById('tableSelect');
const typeSelect = document.getElementById('typeSelect');
const itemSelect = document.getElementById('itemSelect');
const quantityInput = document.getElementById('quantity');
const descriptionInput = document.getElementById('description');
const addItemBtn = document.getElementById('addItemBtn');
const tablesContainer = document.getElementById('tablesContainer');
const paymentOverlay = document.getElementById('paymentOverlay');
const paymentContent = document.getElementById('paymentContent');
const paymentMethod = document.getElementById('paymentMethod');
const paidBtn = document.getElementById('paidBtn');
const closePayment = document.getElementById('closePayment');

// Menu items
const menuItems = {
  food: [{item:'Pizza',price:[500]}, {item:'Burger',price:[200]}],
  drink: [{item:'Soda',price:[50]}, {item:'Beer',price:[100]}]
};

// Local state
let tables = {};
let mergedHistory = {};
let currentPayment = null; // {tableID, subID}

// Firestore refs
const tablesDocRef = doc(db,'posData','tables');

// Init tables in select
for(let i=1;i<=13;i++){
  const opt = document.createElement('option');
  opt.value=i; opt.textContent=i;
  tableSelect.appendChild(opt);
}

// Type -> item population
typeSelect.addEventListener('change', ()=>{
  itemSelect.innerHTML = '<option value="" disabled selected>Select item</option>';
  const arr = menuItems[typeSelect.value]||[];
  arr.forEach(m=>{
    const opt = document.createElement('option');
    opt.value=m.item; opt.textContent=m.item;
    itemSelect.appendChild(opt);
  });
});

// Subscribe to tables
onSnapshot(tablesDocRef,snap=>{
  const data = snap.data();
  tables = data?.tables || {};
  renderTables();
});

// Save tables
async function saveTables(){
  await setDoc(tablesDocRef,{tables});
}

// Add item
addItemBtn.addEventListener('click', async ()=>{
  const tableNum = tableSelect.value;
  const type = typeSelect.value;
  const itemName = itemSelect.value;
  const qty = parseInt(quantityInput.value)||1;
  const desc = (descriptionInput.value||'Person').trim();
  if(!tableNum||!type||!itemName||qty<1){alert('Complete fields'); return;}

  let tableID = Object.keys(tables).find(id=>tables[id].table==tableNum&&tables[id].status!=='closed');
  if(!tableID){
    tableID = 'TABLE-'+Date.now();
    tables[tableID] = {id:tableID,table:tableNum,status:'opened',subOrders:[]};
  }
  const tableOrder = tables[tableID];

  let sub = tableOrder.subOrders.find(s=>s.description===desc);
  if(!sub){
    sub={id:'SUB-'+Date.now(),description:desc,items:[],total:0};
    tableOrder.subOrders.push(sub);
  }

  const price = menuItems[type].find(m=>m.item===itemName)?.price[0]||0;
  sub.items.push({id:'ITEM-'+Date.now(),item:itemName,price,qty,status:'pending'});
  sub.total = sub.items.reduce((s,i)=>s+s.price*i.qty,0);

  await saveTables();
  quantityInput.value='1'; descriptionInput.value='';
});

// Render tables
function renderTables(){
  tablesContainer.innerHTML='';
  Object.values(tables).forEach(table=>{
    if(table.status==='closed') return;
    const box = document.createElement('div'); box.className='table-box';
    const head = document.createElement('div'); head.className='table-head';
    const title = document.createElement('div'); title.innerHTML='<strong>Table '+table.table+'</strong>';
    const total = document.createElement('div'); total.className='table-total';
    total.textContent = table.subOrders.reduce((s,sub)=>s+sub.total,0)+' mts';
    head.appendChild(title); head.appendChild(total);
    box.appendChild(head);

    // Merge / Split buttons (table level)
    const controls = document.createElement('div'); controls.className='person-actions';
    if(table.subOrders.length>1 && !mergedHistory[table.id]){
      const mergeBtn = document.createElement('button'); mergeBtn.textContent='Merge'; mergeBtn.className='merge-btn small';
      mergeBtn.onclick=()=>mergeTable(table.id);
      controls.appendChild(mergeBtn);
    }
    if(mergedHistory[table.id]){
      const splitBtn = document.createElement('button'); splitBtn.textContent='Split'; splitBtn.className='split-btn small';
      splitBtn.onclick=()=>splitTable(table.id);
      controls.appendChild(splitBtn);
    }
    box.appendChild(controls);

    // Render sub-orders
    table.subOrders.forEach(sub=>{
      const pbox = document.createElement('div'); pbox.className='person-box';
      const phead = document.createElement('div'); phead.style.display='flex'; phead.style.justifyContent='space-between';
      const pname = document.createElement('div'); pname.innerHTML='<strong>'+sub.description+'</strong>';
      const ptotal = document.createElement('div'); ptotal.textContent=sub.total+' mts';
      phead.appendChild(pname); phead.appendChild(ptotal);
      pbox.appendChild(phead);

      // Sub-order actions: Serve / Cancel / Pay
      const sactions = document.createElement('div'); sactions.className='person-actions';
      sub.items.forEach(item=>{
        const itemDiv=document.createElement('div'); itemDiv.className='item-box '+(item.status==='pending'?'pending':'served');
        const left=document.createElement('div'); left.style.minWidth='150px';
        const name=document.createElement('div'); name.innerHTML='<strong>'+item.item+' x'+item.qty+'</strong>';
        const status=document.createElement('div'); status.style.fontSize='13px'; status.style.color='#555'; status.textContent='['+item.status+']';
        left.appendChild(name); left.appendChild(status);
        const right=document.createElement('div'); right.style.textAlign='right';
        const priceDiv=document.createElement('div'); priceDiv.style.fontWeight='700'; priceDiv.textContent=item.price*item.qty+' mts';
        const buttons=document.createElement('div'); buttons.style.marginTop='6px';
        if(item.status==='pending'){
          const serveBtn=document.createElement('button'); serveBtn.className='served-btn small'; serveBtn.textContent='Serve';
          serveBtn.onclick=async ()=>{ item.status='served'; await saveTables(); renderTables(); };
          buttons.appendChild(serveBtn);
        }
        const cancelBtn=document.createElement('button'); cancelBtn.className='cancel-btn small'; cancelBtn.textContent='Cancel';
        cancelBtn.onclick=async ()=>{
          const idx=sub.items.findIndex(x=>x.id===item.id);
          if(idx!==-1) sub.items.splice(idx,1);
          sub.total=sub.items.reduce((s,i)=>s+s.price*i.qty,0);
          await saveTables(); renderTables();
        };
        buttons.appendChild(cancelBtn);
        right.appendChild(priceDiv); right.appendChild(buttons);
        itemDiv.appendChild(left); itemDiv.appendChild(right);
        pbox.appendChild(itemDiv);
      });

      // Pay button for sub-order
      const payBtn = document.createElement('button'); payBtn.textContent='Pay'; payBtn.className='add-btn'; 
      payBtn.onclick=()=>openPayment(table.id,sub.id);
      sactions.appendChild(payBtn);
      pbox.appendChild(sactions);
      box.appendChild(pbox);
    });

    // Pay table button
    const payTableBtn = document.createElement('button'); payTableBtn.textContent='Pay Table'; payTableBtn.className='add-btn';
    payTableBtn.onclick=()=>openPayment(table.id,null);
    box.appendChild(payTableBtn);

    tablesContainer.appendChild(box);
  });
}

// Merge / Split
function mergeTable(tableID){
  const t=tables[tableID];
  mergedHistory[tableID]=JSON.parse(JSON.stringify(t.subOrders));
  const mergedItems=[]; t.subOrders.forEach(s=>mergedItems.push(...s.items));
  t.subOrders=[{id:'SUB-'+Date.now(),description:'Merged Order',items:mergedItems,total:mergedItems.reduce((s,i)=>s+s.price*i.qty,0)}];
  saveTables(); renderTables();
}
function splitTable(tableID){
  tables[tableID].subOrders=JSON.parse(JSON.stringify(mergedHistory[tableID]));
  delete mergedHistory[tableID];
  saveTables(); renderTables();
}

// Payment
function openPayment(tableID,subID){
  currentPayment={tableID,subID};
  paymentOverlay.style.display='flex';
  paymentContent.innerHTML='';
  const t=tables[tableID];
  if(subID){
    const sub=t.subOrders.find(s=>s.id===subID);
    sub.items.forEach(it=>{
      const d=document.createElement('div'); d.textContent=it.item+' x'+it.qty+' - '+it.price*it.qty+' mts';
      paymentContent.appendChild(d);
    });
  }else{
    t.subOrders.forEach(sub=>sub.items.forEach(it=>{
      const d=document.createElement('div'); d.textContent=it.item+' x'+it.qty+' - '+it.price*it.qty+' mts';
      paymentContent.appendChild(d);
    }));
  }
}
paidBtn.onclick=async ()=>{
  const {tableID,subID}=currentPayment||{};
  if(!tableID||!paymentMethod.value) return alert('Select method');
  const t=tables[tableID];
  if(subID){
    const sub=t.subOrders.find(s=>s.id===subID);
    sub.items.forEach(i=>i.status='paid');
  }else{
    t.subOrders.forEach(sub=>sub.items.forEach(i=>i.status='paid'));
    t.status='closed';
  }
  await saveTables(); renderTables(); paymentOverlay.style.display='none';
};
closePayment.onclick=()=>paymentOverlay.style.display='none';

</script>
</body>
</html>
