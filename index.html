<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Waiter POS — TRUE MERGE (Merged Order + Payment)</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
  :root{--primary:#0062ca;--green:#28a745;--muted:#f4f4f4}
  body{font-family:Segoe UI, Tahoma, Geneva, Verdana, sans-serif;background:var(--muted);padding:18px;display:flex;flex-direction:column;align-items:center;gap:12px}
  .order-box{background:var(--primary);padding:18px;border-radius:12px;color:#fff;width:380px;box-shadow:0 8px 24px rgba(0,0,0,.12)}
  .order-box h2{margin:0 0 10px;font-size:18px;text-align:center}
  input,select{width:100%;padding:9px;margin:6px 0;border-radius:8px;border:none;font-size:15px;outline:none}
  .add-btn{background:var(--green);color:#fff;border-radius:8px;padding:10px;font-weight:700;cursor:pointer;border:none}
  .tables-container{display:flex;flex-wrap:wrap;gap:14px;justify-content:center;width:100%}
  .table-box{background:#fff;padding:12px;border-radius:12px;width:340px;box-shadow:0 8px 20px rgba(0,0,0,.12);max-height:640px;overflow:auto}
  .table-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .table-total{font-weight:700}
  .person-box{background:#f0f0f0;padding:8px;border-radius:10px;margin-bottom:8px}
  .person-actions{display:flex;gap:6px;margin-top:6px;flex-wrap:wrap}
  .item-box{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;margin:6px 0;background:#fff}
  .pending{background:#fff7e6}
  .served{background:#e9f7ee}
  button.small{padding:6px 8px;border-radius:8px;border:none;cursor:pointer}
  .served-btn{background:var(--green);color:#fff}
  .cancel-btn{background:#dc3545;color:#fff}
  .merge-btn{background:#007bff;color:#fff}
  .split-btn{background:#ffc107;color:#222}
  .move-select{padding:6px;border-radius:6px}
  .low-stock{color:#d9534f;font-weight:700;font-size:13px}
  .note{font-size:13px;color:#666;margin-top:6px}
  .controls-row{display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap}
  .modal-bg{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.4);display:flex;justify-content:center;align-items:center;z-index:999;display:none}
  .modal{background:#fff;padding:18px;border-radius:12px;width:300px;max-height:80vh;overflow:auto;display:flex;flex-direction:column;gap:12px}
  .modal h3{margin:0;text-align:center}
  .payment-methods{display:flex;flex-direction:column;gap:6px}
  @media(max-width:760px){ .order-box,.table-box{width:92%} .tables-container{flex-direction:column;align-items:center} }
</style>
</head>
<body>

<div class="order-box">
  <h2><i class="fas fa-utensils"></i> Waiter POS</h2>

  <label>Table</label>
  <select id="tableSelect"><option value="" disabled selected>Select table</option></select>

  <label>Description (person / note)</label>
  <input id="description" placeholder="e.g. John / Veggie" />

  <label>Type</label>
  <select id="typeSelect"><option value="" disabled selected>Select type</option><option value="food">Food</option><option value="drink">Drink</option></select>

  <label>Item</label>
  <select id="itemSelect"><option value="" disabled selected>Select item</option></select>

  <select id="priceSelect" style="display:none"></select>

  <label>Quantity</label>
  <input id="quantity" type="number" min="1" value="1" />

  <div style="display:flex;gap:8px;align-items:center">
    <button id="addItemBtn" class="add-btn"><i class="fas fa-plus"></i> Add Item</button>
    <div id="stockNote" style="margin-left:8px"></div>
  </div>

  <div class="note">Inventory updates on add. Canceling items restores stock. Merge produces one real sub-order named "Merged Order".</div>
</div>

<div id="tablesContainer" class="tables-container"></div>

<!-- Payment Modal -->
<div id="paymentModal" class="modal-bg">
  <div class="modal">
    <h3>Pay Table</h3>
    <div id="modalContent"></div>
    <label>Payment Method</label>
    <select id="paymentMethodSelect">
      <option value="" disabled selected>Select method</option>
      <option value="Mobile">Mobile</option>
      <option value="Card">Card</option>
      <option value="Cash">Cash</option>
    </select>
    <button id="payBtn" class="add-btn">Paid</button>
    <button id="closeModalBtn" class="small" style="background:#ccc;color:#000">Close</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getFirestore, doc, setDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC6VdctOXcT-qHaLJs1gEzwzVv5AdK5e0w",
  authDomain: "pos-system-9a056.firebaseapp.com",
  projectId: "pos-system-9a056",
  storageBucket: "pos-system-9a056.firebasestorage.app",
  messagingSenderId: "701001104012",
  appId: "1:701001104012:web:294967faec11a627c819a9"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const tableSelect = document.getElementById('tableSelect');
const typeSelect = document.getElementById('typeSelect');
const itemSelect = document.getElementById('itemSelect');
const priceSelect = document.getElementById('priceSelect');
const quantityInput = document.getElementById('quantity');
const descriptionInput = document.getElementById('description');
const addItemBtn = document.getElementById('addItemBtn');
const tablesContainer = document.getElementById('tablesContainer');
const stockNote = document.getElementById('stockNote');

const paymentModal = document.getElementById('paymentModal');
const modalContent = document.getElementById('modalContent');
const paymentMethodSelect = document.getElementById('paymentMethodSelect');
const payBtn = document.getElementById('payBtn');
const closeModalBtn = document.getElementById('closeModalBtn');

const menuItems = {
  food: [
    {item:'Salsicha',price:[200]}, {item:'Sasicha c/ Queijo',price:[300]}, {item:'Worse',price:[200]},
    {item:'Babalaza',price:[300]}, {item:'Rabada',price:[200]}, {item:'Língua',price:[200]},
    {item:'Brisket',price:[400]}, {item:'Figado de vaca',price:[300]}, {item:'Cordornizes',price:[350]},
    {item:'Moela',price:[300]}, {item:'Sopa de legumes',price:[270]}, {item:'Sopa de Feijão',price:[220]},
    {item:'Salgadinhos (dose)',price:[100]}, {item:'Pizza Grande',price:[600]}, {item:'Pizza Pequena',price:[350]},
    {item:'Picanha',price:[500]}, {item:'T-Bone',price:[450]}, {item:'Lombo',price:[300]}, {item:'Bife',price:[600]},
    {item:'Bitoque',price:[500]}, {item:'Prego Completo',price:[250]}, {item:'Prego no Prato',price:[300]},
    {item:'Lasanha',price:[600]}, {item:'Pernil',price:[350]}, {item:'Carne de Porco',price:[350]},
    {item:'Costuleta',price:[500,850]}, {item:'Frango Inteiro',price:[700]}, {item:'Meio Frango',price:[350]},
    {item:'Dose de Frango',price:[250]}, {item:'Peixe c/m legumes',price:[600]}
  ],
  drink: [
    {item:'2M Grande',price:[70]}, {item:'Savana',price:[80]}, {item:'Heineken',price:[80]}, {item:'Heineken Grande',price:[70]},
    {item:'Impala',price:[60]}, {item:'Txilar a lata',price:[60]}, {item:'Txilar garrafa',price:[70]},
    {item:'Corona',price:[100]}, {item:'Brutal a garafa',price:[80]}, {item:'Brutal a lata',price:[100]},
    {item:'Água Tônica',price:[70]}, {item:'May fair',price:[90]}, {item:'Flying Fish',price:[80]}, {item:'Lite',price:[80]},
    {item:'Black Crown',price:[80]}, {item:'Stella',price:[100]}, {item:'Bernina',price:[90]}, {item:'Whisky Jameson',price:[150,1250]},
    {item:'Amarula',price:[150,850]}, {item:'Paul Cluver Branco',price:[850]}, {item:'Roodberg Black',price:[900]},
    {item:'Vinho da Casa',price:[200]}, {item:'Refresco 2L',price:[110]}, {item:'Refresco 1L',price:[70]}, {item:'Refresco a lata',price:[70]},
    {item:'Sumo compal',price:[70]}, {item:'Sumo compal 1L',price:[140]}, {item:'Chá Simples',price:[50]}
  ]
};

let tables = {};
let mergedHistory = {};
let stock = {};

const tablesDocRef = doc(db,'posData','tables');
const stockDocRef = doc(db,'posData','stock');

(async function initIfEmpty(){
  const tSnap = await getDoc(tablesDocRef);
  if(!tSnap.exists()) await setDoc(tablesDocRef, { tables: {} });
  const sSnap = await getDoc(stockDocRef);
  if(!sSnap.exists()){
    for(const k of ['food','drink']){
      menuItems[k].forEach(m => { stock[m.item] = 20; });
    }
    await setDoc(stockDocRef, { stock });
  }
})();

onSnapshot(stockDocRef, snap=>{ const data = snap.data(); if(data && data.stock) stock = data.stock; renderStockNote(); });
onSnapshot(tablesDocRef, snap=>{ const data = snap.data(); tables = (data && data.tables) ? data.tables : {}; renderTables(); });

async function saveTablesToFirebase(){ for(const key in tables){ if(!tables[key].subOrders || tables[key].subOrders.length===0) delete tables[key]; else tables[key].subOrders = tables[key].subOrders.filter(s=>s.items && s.items.length>0); } await setDoc(tablesDocRef, { tables }); }
async function saveStockToFirebase(){ await setDoc(stockDocRef, { stock }); }

for(let i=1;i<=13;i++){ const opt = document.createElement('option'); opt.value=i; opt.textContent=i; tableSelect.appendChild(opt); }
typeSelect.addEventListener('change', ()=>{ itemSelect.innerHTML='<option value="" disabled selected>Select item</option>'; (menuItems[typeSelect.value]||[]).forEach(m=>{ const opt=document.createElement('option'); opt.value=m.item; opt.textContent=m.item; itemSelect.appendChild(opt); }); priceSelect.style.display='none'; });
itemSelect.addEventListener('change', ()=>{ const arr=menuItems[typeSelect.value]||[]; const menuItem=arr.find(m=>m.item===itemSelect.value); if(menuItem && menuItem.price.length>1){ priceSelect.innerHTML='<option value="" disabled selected>Select price</option>'; menuItem.price.forEach(p=>{ const opt=document.createElement('option'); opt.value=p; opt.textContent=p+' mts'; priceSelect.appendChild(opt); }); priceSelect.style.display='block'; } else priceSelect.style.display='none'; });

function renderStockNote(){ const lows=Object.entries(stock).filter(([,q])=>q<=3).slice(0,4); stockNote.innerHTML=lows.length?`<span class="low-stock">Low: ${lows.map(([i])=>i).join(', ')}</span>`:''; }

addItemBtn.addEventListener('click', async ()=>{
  const tableNum=tableSelect.value, type=typeSelect.value, itemName=itemSelect.value;
  const price=priceSelect.style.display==='block'?parseInt(priceSelect.value):(menuItems[type]||[]).find(m=>m.item===itemName)?.price[0];
  const qty=parseInt(quantityInput.value)||1, desc=(descriptionInput.value||'Person').trim();
  if(!tableNum||!type||!itemName||!price||qty<1){ alert('Select Table, Type, Item and Quantity.'); return; }
  const available=(stock[itemName]===undefined)?Infinity:stock[itemName];
  if(available!==Infinity && available<qty){ alert(`Not enough stock for "${itemName}". Available: ${available}`); return; }

  let tableID=Object.keys(tables).find(id=>tables[id].table==tableNum && tables[id].tableStatus==='opened');
  if(!tableID){ tableID='TABLE-'+Date.now(); tables[tableID]={id:tableID,table:tableNum,tableStatus:'opened',time:new Date().toISOString(),subOrders:[]}; }
  const tableOrder=tables[tableID];
  let sub=tableOrder.subOrders.find(s=>s.description===desc);
  if(!sub){ sub={personID:'PERSON-'+Date.now(),description:desc,items:[],totalPrice:0,paid:false,paymentMethod:null,paymentTime:null}; tableOrder.subOrders.push(sub); }

  const newItem={id:'ITEM-'+Date.now(),item:itemName,price,quantity:qty,status:'pending',time:new Date().toISOString()};
  sub.items.push(newItem); sub.totalPrice=sub.items.reduce((s,i)=>s+i.price*i.quantity,0);
  if(stock[itemName]!==undefined && stock[itemName]!==Infinity) stock[itemName]=Math.max(0,(stock[itemName]||0)-qty);
  await saveStockToFirebase(); await saveTablesToFirebase();
  quantityInput.value=1; descriptionInput.value=''; renderTables();
});

function renderTables(){
  tablesContainer.innerHTML='';
  Object.values(tables).filter(t=>t.tableStatus==='opened').sort((a,b)=>b.time.localeCompare(a.time)).forEach(tableOrder=>{
    const box=document.createElement('div'); box.className='table-box';
    const total=(tableOrder.subOrders||[]).reduce((s,sub)=>s+(sub.totalPrice||0),0);
    box.innerHTML=`<div class="table-head"><div><strong>Table ${tableOrder.table}</strong></div><div class="table-total">${total} mts</div></div>`;

    const wholeControls=document.createElement('div'); wholeControls.className='controls-row';
    const moveSelect=document.createElement('select'); moveSelect.className='move-select';
    moveSelect.innerHTML=`<option value="" disabled selected>Move table</option>${[...Array(13)].map((_,i)=>`<option value="${i+1}">${i+1}</option>`).join('')}`; wholeControls.appendChild(moveSelect);
    const moveBtn=document.createElement('button'); moveBtn.className='small'; moveBtn.textContent='Move';
    moveBtn.addEventListener('click', async ()=>{ const newTable=moveSelect.value; if(!newTable){ alert('Choose a table to move to'); return; } if(String(newTable)===String(tableOrder.table)){ alert('Already on that table'); return; } tableOrder.table=newTable; const oldID=tableOrder.id; await saveTablesToFirebase(); if(mergedHistory[oldID]){ mergedHistory['TABLE-'+Date.now()]=mergedHistory[oldID]; delete mergedHistory[oldID]; } renderTables(); });
    wholeControls.appendChild(moveBtn);

    if((tableOrder.subOrders||[]).length>1 && !mergedHistory[tableOrder.id]){
      const mergeBtn=document.createElement('button'); mergeBtn.className='merge-btn small'; mergeBtn.textContent='Merge';
      mergeBtn.addEventListener('click', async ()=>{ mergedHistory[tableOrder.id]=JSON.parse(JSON.stringify(tableOrder.subOrders)); const mergedItems=[]; tableOrder.subOrders.forEach(s=>mergedItems.push(...s.items)); tableOrder.subOrders=[{personID:'PERSON-'+Date.now(),description:'Merged Order',items:mergedItems,totalPrice:mergedItems.reduce((s,i)=>s+i.price*i.quantity,0),paid:false,paymentMethod:null,paymentTime:null}]; await saveTablesToFirebase(); renderTables(); });
      wholeControls.appendChild(mergeBtn);
    }
    box.appendChild(wholeControls);

    (tableOrder.subOrders||[]).forEach(sub=>{
      const pBox=document.createElement('div'); pBox.className='person-box';
      pBox.innerHTML=`<strong>${sub.description}</strong> — ${sub.totalPrice} mts`;
      sub.items.forEach(i=>{
        const itBox=document.createElement('div'); itBox.className='item-box '+(i.status==='served'?'served':'pending');
        itBox.innerHTML=`<span>${i.item} x${i.quantity}</span><span>${i.price*i.quantity} mts</span>`;
        const serveBtn=document.createElement('button'); serveBtn.className='served-btn small'; serveBtn.textContent='Served';
        serveBtn.addEventListener('click', async ()=>{ i.status='served'; await saveTablesToFirebase(); renderTables(); });
        const cancelBtn=document.createElement('button'); cancelBtn.className='cancel-btn small'; cancelBtn.textContent='Cancel';
        cancelBtn.addEventListener('click', async ()=>{ const qty=i.quantity; if(stock[i.item]!==undefined && stock[i.item]!==Infinity) stock[i.item]+=qty; sub.items=sub.items.filter(x=>x.id!==i.id); sub.totalPrice=sub.items.reduce((s,x)=>s+x.price*x.quantity,0); if(sub.items.length===0) tableOrder.subOrders=tableOrder.subOrders.filter(x=>x.personID!==sub.personID); await saveStockToFirebase(); await saveTablesToFirebase(); renderTables(); });
        const itemControls=document.createElement('div'); itemControls.className='person-actions';
        itemControls.appendChild(serveBtn); itemControls.appendChild(cancelBtn);
        itBox.appendChild(itemControls); pBox.appendChild(itBox);
      });

      const payButton=document.createElement('button'); payButton.className='add-btn'; payButton.textContent='Pay';
      payButton.addEventListener('click', ()=>{ openPaymentModal(tableOrder.id,sub.personID); });
      pBox.appendChild(payButton); box.appendChild(pBox);
    });
    tablesContainer.appendChild(box);
  });
}

function openPaymentModal(tableID, personID){
  const sub=tables[tableID].subOrders.find(s=>s.personID===personID);
  if(!sub) return;
  modalContent.innerHTML=`<strong>${sub.description}</strong> — ${sub.totalPrice} mts`;
  paymentModal.style.display='flex';
  payBtn.onclick=async ()=>{
    const method=paymentMethodSelect.value; if(!method){ alert('Choose payment method'); return; }
    sub.paid=true; sub.paymentMethod=method; sub.paymentTime=new Date().toISOString();
    await saveTablesToFirebase();
    paymentModal.style.display='none'; paymentMethodSelect.value='';
    renderTables();
  };
}

closeModalBtn.addEventListener('click', ()=>{ paymentModal.style.display='none'; });
</script>

</body>
</html>
