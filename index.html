<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Waiter POS</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
:root{--primary:#0062ca;--green:#28a745;--muted:#f4f4f4}
body{font-family:Segoe UI,Tahoma,Geneva,Verdana,sans-serif;background:var(--muted);padding:18px;display:flex;flex-direction:column;align-items:center;gap:12px}
.order-box{background:var(--primary);padding:18px;border-radius:12px;color:#fff;width:380px;box-shadow:0 8px 24px rgba(0,0,0,.12)}
.order-box h2{margin:0 0 10px;font-size:18px;text-align:center}
input,select{width:100%;padding:9px;margin:6px 0;border-radius:8px;border:none;font-size:15px;outline:none}
.add-btn{background:var(--green);color:#fff;border-radius:8px;padding:10px;font-weight:700;cursor:pointer;border:none}
.tables-container{display:flex;flex-wrap:wrap;gap:14px;justify-content:center;width:100%}
.table-box{background:#fff;padding:12px;border-radius:12px;width:340px;box-shadow:0 8px 20px rgba(0,0,0,.12);max-height:640px;overflow:auto}
.table-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.table-total{font-weight:700}
.person-box{background:#f0f0f0;padding:8px;border-radius:10px;margin-bottom:8px}
.person-actions{display:flex;gap:6px;margin-top:6px;flex-wrap:wrap}
.item-box{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;margin:6px 0;background:#fff}
.pending{background:#fff7e6}
.served{background:#e9f7ee}
button.small{padding:6px 8px;border-radius:8px;border:none;cursor:pointer}
.served-btn{background:var(--green);color:#fff}
.cancel-btn{background:#dc3545;color:#fff}
.merge-btn{background:#007bff;color:#fff}
.split-btn{background:#ffc107;color:#222}
.move-select{padding:6px;border-radius:6px}
.controls-row{display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap}
.payment-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:flex;justify-content:center;align-items:center;z-index:1000;display:none}
.payment-content{background:#fff;padding:20px;border-radius:12px;width:90%;max-width:500px;max-height:80%;overflow:auto}
.payment-content h3{margin-top:0;text-align:center}
.payment-methods{display:flex;gap:12px;margin-bottom:12px}
.payment-methods select{flex:1;padding:6px;border-radius:6px}
.payment-content button{margin-top:12px;padding:10px;border:none;border-radius:8px;background:var(--green);color:#fff;cursor:pointer}
@media(max-width:760px){.order-box,.table-box{width:92%}.tables-container{flex-direction:column;align-items:center}}
</style>
</head>
<body>

<div class="order-box">
<h2><i class="fas fa-utensils"></i> Waiter POS</h2>

<label>Table</label>
<select id="tableSelect"><option value="" disabled selected>Select table</option></select>

<label>Description (person/note)</label>
<input id="description" placeholder="e.g. John / Veggie">

<label>Type</label>
<select id="typeSelect"><option value="" disabled selected>Select type</option><option value="food">Food</option><option value="drink">Drink</option></select>

<label>Item</label>
<select id="itemSelect"><option value="" disabled selected>Select item</option></select>

<select id="priceSelect" style="display:none"></select>

<label>Quantity</label>
<input id="quantity" type="number" min="1" value="1">

<div style="display:flex;gap:8px;align-items:center">
<button id="addItemBtn" class="add-btn"><i class="fas fa-plus"></i> Add Item</button>
</div>

</div>

<div id="tablesContainer" class="tables-container"></div>

<div class="payment-overlay" id="paymentOverlay">
<div class="payment-content">
<h3>Payment</h3>
<div id="paymentSubOrders"></div>
<div class="payment-methods">
<select id="paymentMethod"><option value="" disabled selected>Select payment method</option><option value="cash">Cash</option><option value="card">Card</option><option value="mobile">Mobile</option></select>
<button id="payBtn">Paid</button>
</div>
<button id="closePaymentBtn">Close</button>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

const firebaseConfig = {
apiKey: "YOUR_API_KEY",
authDomain: "YOUR_AUTH_DOMAIN",
projectId: "YOUR_PROJECT_ID",
storageBucket: "YOUR_STORAGE_BUCKET",
messagingSenderId: "YOUR_SENDER_ID",
appId: "YOUR_APP_ID"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const tableSelect = document.getElementById('tableSelect');
const typeSelect = document.getElementById('typeSelect');
const itemSelect = document.getElementById('itemSelect');
const priceSelect = document.getElementById('priceSelect');
const quantityInput = document.getElementById('quantity');
const descriptionInput = document.getElementById('description');
const addItemBtn = document.getElementById('addItemBtn');
const tablesContainer = document.getElementById('tablesContainer');

const paymentOverlay = document.getElementById('paymentOverlay');
const paymentSubOrders = document.getElementById('paymentSubOrders');
const paymentMethod = document.getElementById('paymentMethod');
const payBtn = document.getElementById('payBtn');
const closePaymentBtn = document.getElementById('closePaymentBtn');

const menuItems = {
food:[{item:'Pizza',price:[600]},{item:'Burger',price:[350]}],
drink:[{item:'Coke',price:[70]},{item:'Water',price:[50]}]
};

let tables = {};
let mergedHistory = {};

const tablesDocRef = doc(db,'posData','tables');

async function saveTables(){await setDoc(tablesDocRef,{tables})}
async function loadTables(){const snap=await getDoc(tablesDocRef);if(snap.exists()) tables=snap.data().tables||{};renderTables()}

loadTables();
onSnapshot(tablesDocRef,snap=>{if(snap.exists()){tables=snap.data().tables||{};renderTables()}});

for(let i=1;i<=13;i++){const opt=document.createElement('option');opt.value=i;opt.textContent=i;tableSelect.appendChild(opt)}

typeSelect.addEventListener('change',()=>{
itemSelect.innerHTML='<option value="" disabled selected>Select item</option>';
(menuItems[typeSelect.value]||[]).forEach(m=>{const opt=document.createElement('option');opt.value=m.item;opt.textContent=m.item;itemSelect.appendChild(opt)});
priceSelect.style.display='none'});

itemSelect.addEventListener('change',()=>{
const arr=menuItems[typeSelect.value]||[];
const m=arr.find(x=>x.item===itemSelect.value);
if(m&&m.price.length>1){priceSelect.innerHTML='<option value="" disabled selected>Select price</option>';
m.price.forEach(p=>{const opt=document.createElement('option');opt.value=p;opt.textContent=p+' mts';priceSelect.appendChild(opt)});
priceSelect.style.display='block'}else priceSelect.style.display='none'});

addItemBtn.addEventListener('click',async()=>{
const tableNum=tableSelect.value,type=typeSelect.value,itemName=itemSelect.value;
const price=priceSelect.style.display==='block'?parseInt(priceSelect.value):(menuItems[type]||[]).find(x=>x.item===itemName)?.price[0];
const qty=parseInt(quantityInput.value)||1;
const desc=(descriptionInput.value||'Person').trim();
if(!tableNum||!type||!itemName||!price||qty<1){alert('Select Table, Type, Item, Quantity');return}

let tableID=Object.keys(tables).find(id=>tables[id].table==tableNum&&tables[id].tableStatus==='opened');
if(!tableID){tableID='TABLE-'+Date.now();tables[tableID]={id:tableID,table:tableNum,tableStatus:'opened',time:new Date().toISOString(),subOrders:[]}}
const tableOrder=tables[tableID];
let sub=tableOrder.subOrders.find(s=>s.description===desc);
if(!sub){sub={personID:'PERSON-'+Date.now(),description:desc,items:[],totalPrice:0};tableOrder.subOrders.push(sub)}
sub.items.push({id:'ITEM-'+Date.now(),item:itemName,price,quantity:qty,status:'pending',time:new Date().toISOString()});
sub.totalPrice=sub.items.reduce((s,i)=>s+i.price*i.quantity,0);
await saveTables();quantityInput.value=1;descriptionInput.value='';renderTables()});

function renderTables(){tablesContainer.innerHTML='';Object.values(tables).filter(t=>t.tableStatus==='opened').forEach(tableOrder=>{
const box=document.createElement('div');box.className='table-box';
const total=(tableOrder.subOrders||[]).reduce((s,sb)=>s+(sb.totalPrice||0),0);
box.innerHTML=`<div class="table-head"><div><strong>Table ${tableOrder.table}</strong></div><div class="table-total">${total} mts</div></div>`;

const wholeControls=document.createElement('div');wholeControls.className='controls-row';
const moveSelect=document.createElement('select');moveSelect.className='move-select';
moveSelect.innerHTML=`<option value="" disabled selected>Move table</option>${[...Array(13)].map((_,i)=>`<option value="${i+1}">${i+1}</option>`).join('')}`;
wholeControls.appendChild(moveSelect);
const moveBtn=document.createElement('button');moveBtn.className='small';moveBtn.textContent='Move';
moveBtn.addEventListener('click',async()=>{const newTable=moveSelect.value;if(!newTable){alert('Choose table');return}if(String(newTable)===String(tableOrder.table)){alert('Already on that table');return}tableOrder.table=newTable;await saveTables();renderTables()});wholeControls.appendChild(moveBtn);

if((tableOrder.subOrders||[]).length>1&&!mergedHistory[tableOrder.id]){
const mergeBtn=document.createElement('button');mergeBtn.className='merge-btn small';mergeBtn.textContent='Merge';
mergeBtn.addEventListener('click',async()=>{mergedHistory[tableOrder.id]=JSON.parse(JSON.stringify(tableOrder.subOrders));
const mergedItems=[];tableOrder.subOrders.forEach(s=>mergedItems.push(...s.items));
const mergedSub={personID:'PERSON-'+Date.now(),description:'Merged Order',items:mergedItems,totalPrice:mergedItems.reduce((s,i)=>s+i.price*i.quantity,0)};
tableOrder.subOrders=[mergedSub];await saveTables();renderTables()});wholeControls.appendChild(mergeBtn)}

if(mergedHistory[tableOrder.id]){
const splitBtn=document.createElement('button');splitBtn.className='split-btn small';splitBtn.textContent='Split';
splitBtn.addEventListener('click',async()=>{tableOrder.subOrders=JSON.parse(JSON.stringify(mergedHistory[tableOrder.id]));delete mergedHistory[tableOrder.id];await saveTables();renderTables()});wholeControls.appendChild(splitBtn)}

const payBtnTable=document.createElement('button');payBtnTable.className='small';payBtnTable.textContent='Pay Table';
payBtnTable.addEventListener('click',()=>{showPayment(tableOrder.id)});wholeControls.appendChild(payBtnTable);

box.appendChild(wholeControls);

(tableOrder.subOrders||[]).forEach((sub,subIndex)=>{
const p=document.createElement('div');p.className='person-box';
p.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${sub.description}</strong></div><div>${sub.totalPrice||0} mts</div></div>`;

const controls=document.createElement('div');controls.className='person-actions';
const moveS=document.createElement('select');moveS.className='move-select';
moveS.innerHTML=`<option value="" disabled selected>Move sub-order</option>${[...Array(13)].map((_,i)=>`<option value="${i+1}">${i+1}</option>`).join('')}`;
controls.appendChild(moveS);
const moveSBtn=document.createElement('button');moveSBtn.className='small';moveSBtn.textContent='Move';
moveSBtn.addEventListener('click',async()=>{const newTable=moveS.value;if(!newTable){alert('Choose table');return}if(String(newTable)===String(tableOrder.table)){alert('Already on that table');return}const moved=JSON.parse(JSON.stringify(sub));tableOrder.subOrders.splice(subIndex,1);if(!tableOrder.subOrders.length) delete tables[tableOrder.id];let targetID=Object.keys(tables).find(id=>tables[id].table==newTable&&tables[id].tableStatus==='opened');if(!targetID){targetID='TABLE-'+Date.now();tables[targetID]={id:targetID,table:newTable,tableStatus:'opened',time:new Date().toISOString(),subOrders:[]}};tables[targetID].subOrders.push(moved);if(mergedHistory[tableOrder.id]) delete mergedHistory[tableOrder.id];saveTables();renderTables()});controls.appendChild(moveSBtn);
const paySubBtn=document.createElement('button');paySubBtn.className='small';paySubBtn.textContent='Pay';paySubBtn.addEventListener('click',()=>{showPayment(tableOrder.id,sub.personID)});controls.appendChild(paySubBtn);
p.appendChild(controls);

sub.items.forEach(it=>{const itemDiv=document.createElement('div');itemDiv.className='item-box '+(it.status==='pending'?'pending':'served');itemDiv.innerHTML=`<div style="min-width:150px"><div><strong>${it.item} x${it.quantity}</strong></div><div style="font-size:13px;color:#555">[${it.status}]</div></div><div style="text-align:right"><div style="font-weight:700">${it.price*it.quantity} mts</div><div style="margin-top:6px">${it.status==='pending'?'<button class="served-btn small">Served</button>':''}<button class="cancel-btn small">Cancel</button></div></div>`;if(it.status==='pending'){itemDiv.querySelector('.served-btn').addEventListener('click',async()=>{it.status='served';await saveTables();renderTables()})}itemDiv.querySelector('.cancel-btn').addEventListener('click',async()=>{const idx=sub.items.findIndex(x=>x.id===it.id);if(idx!==-1) sub.items.splice(idx,1);sub.totalPrice=sub.items.reduce((s,i)=>s+i.price*i.quantity,0);if(sub.items.length===0){const sIndex=tableOrder.subOrders.findIndex(sx=>sx.personID===sub.personID);if(sIndex!==-1) tableOrder.subOrders.splice(sIndex,1)}if(tableOrder.subOrders.length===0) delete tables[tableOrder.id];await saveTables();renderTables()});p.appendChild(itemDiv});box.appendChild(p)});

tablesContainer.appendChild(box)})}

function showPayment(tableID,personID=null){
paymentSubOrders.innerHTML='';
const table=tables[tableID];if(!table) return;
const subs=personID?table.subOrders.filter(s=>s.personID===personID):table.subOrders;
subs.forEach(s=>{const div=document.createElement('div');div.textContent=`${s.description}: ${s.totalPrice} mts`;paymentSubOrders.appendChild(div)});
paymentOverlay.style.display='flex';
payBtn.onclick=async()=>{
const method=paymentMethod.value;if(!method){alert('Select payment method');return}
subs.forEach(s=>{s.paid=true;s.paymentMethod=method});await saveTables();paymentOverlay.style.display='none';renderTables()
};
closePaymentBtn.onclick=()=>{paymentOverlay.style.display='none';};
}
</script>
</body>
</html>
