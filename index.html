<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ultra POS</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
:root{--primary:#0062ca;--green:#28a745;--muted:#f4f4f4;}
body{font-family:Segoe UI,sans-serif;background:var(--muted);margin:0;padding:20px;display:flex;flex-direction:column;align-items:center;gap:20px;}
.header{font-size:24px;font-weight:700;margin-bottom:12px;}
.controls, .tables-container{width:100%;max-width:1200px;display:flex;flex-wrap:wrap;gap:20px;justify-content:center;}
.order-box, .table-box{background:#fff;border-radius:12px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.12);width:300px;}
.order-box h2{margin-top:0;text-align:center;color:var(--primary);}
.order-box select,input,button{width:100%;margin:6px 0;padding:8px;border-radius:8px;border:none;font-size:14px;outline:none;}
button.add-btn{background:var(--green);color:#fff;font-weight:700;cursor:pointer;}
.table-box h3{margin-top:0;color:var(--primary);}
.person-box{background:#f0f0f0;padding:8px;border-radius:8px;margin-bottom:8px;}
.item-box{display:flex;justify-content:space-between;align-items:center;padding:6px;border-radius:6px;margin:4px 0;background:#fff;}
.item-box.pending{background:#fff7e6;}
.item-box.served{background:#e9f7ee;}
.item-box.paid{background:#d4edda;}
.person-actions{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px;}
button.small{padding:4px 6px;border-radius:6px;border:none;cursor:pointer;}
.payment-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:flex;justify-content:center;align-items:center;z-index:100;display:none;}
.payment-box{background:#fff;padding:20px;border-radius:12px;width:350px;max-height:80%;overflow:auto;}
</style>
</head>
<body>

<div class="header">Ultra POS System</div>

<div class="order-box">
<h2><i class="fas fa-utensils"></i> New Order</h2>

<label>Table</label>
<select id="tableSelect"><option value="" disabled selected>Select Table</option></select>

<label>Sub-Order Description</label>
<input id="description" placeholder="e.g. John / Veggie" />

<label>Type</label>
<select id="typeSelect"><option value="" disabled selected>Select Type</option><option value="food">Food</option><option value="drink">Drink</option></select>

<label>Item</label>
<select id="itemSelect"><option value="" disabled selected>Select Item</option></select>

<label>Quantity</label>
<input id="quantity" type="number" min="1" value="1" />

<button id="addItemBtn" class="add-btn"><i class="fas fa-plus"></i> Add Item</button>
</div>

<div id="tablesContainer" class="tables-container"></div>

<!-- Payment Overlay -->
<div id="paymentOverlay" class="payment-overlay">
<div class="payment-box">
<h3>Payment</h3>
<div id="paymentContent"></div>
<label>Payment Method</label>
<select id="paymentMethod">
<option value="" disabled selected>Select Method</option>
<option value="cash">Cash</option>
<option value="card">Card</option>
<option value="mobile">Mobile</option>
</select>
<button id="paidBtn" class="add-btn" style="margin-top:10px;">Paid</button>
<button id="closePayment" class="add-btn" style="background:#dc3545;margin-top:10px;">Close</button>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyC6VdctOXcT-qHaLJs1gEzwzVv5AdK5e0w",
  authDomain: "pos-system-9a056.firebaseapp.com",
  projectId: "pos-system-9a056",
  storageBucket: "pos-system-9a056.firebasestorage.app",
  messagingSenderId: "701001104012",
  appId: "1:701001104012:web:294967faec11a627c819a9"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// UI Elements
const tableSelect = document.getElementById('tableSelect');
const typeSelect = document.getElementById('typeSelect');
const itemSelect = document.getElementById('itemSelect');
const quantityInput = document.getElementById('quantity');
const descriptionInput = document.getElementById('description');
const addItemBtn = document.getElementById('addItemBtn');
const tablesContainer = document.getElementById('tablesContainer');
const paymentOverlay = document.getElementById('paymentOverlay');
const paymentContent = document.getElementById('paymentContent');
const paymentMethod = document.getElementById('paymentMethod');
const paidBtn = document.getElementById('paidBtn');
const closePayment = document.getElementById('closePayment');

// Menu
const menuItems = {
food: [{item:'Pizza',price:500},{item:'Burger',price:200},{item:'Salad',price:150}],
drink: [{item:'Soda',price:50},{item:'Juice',price:80},{item:'Beer',price:100}]
};

// Local state
let tables = {};
let mergedHistory = {};
let currentPayment = null;

// Firestore reference
const tablesDocRef = doc(db,'posData','tables');

// Init table options
for(let i=1;i<=13;i++){
  const opt=document.createElement('option');
  opt.value=i; opt.textContent=i;
  tableSelect.appendChild(opt);
}

// Type -> item
typeSelect.addEventListener('change',()=>{
  itemSelect.innerHTML='<option value="" disabled selected>Select Item</option>';
  (menuItems[typeSelect.value]||[]).forEach(m=>{
    const opt=document.createElement('option'); opt.value=m.item; opt.textContent=m.item;
    itemSelect.appendChild(opt);
  });
});

// Firestore subscription
onSnapshot(tablesDocRef,snap=>{
  tables = snap.data()?.tables || {};
  renderTables();
});

// Save
async function saveTables(){ await setDoc(tablesDocRef,{tables}); }

// Add item
addItemBtn.addEventListener('click',async()=>{
  const tableNum = tableSelect.value;
  const type = typeSelect.value;
  const itemName = itemSelect.value;
  const qty = parseInt(quantityInput.value)||1;
  const desc = (descriptionInput.value||'Person').trim();
  if(!tableNum||!type||!itemName||qty<1){alert('Complete all fields');return;}

  let tableID = Object.keys(tables).find(id=>tables[id].table==tableNum&&tables[id].status!=='closed');
  if(!tableID){
    tableID='TABLE-'+Date.now();
    tables[tableID]={id:tableID,table:tableNum,status:'opened',subOrders:[]};
  }
  const tableOrder = tables[tableID];

  let sub = tableOrder.subOrders.find(s=>s.description===desc);
  if(!sub){ sub={id:'SUB-'+Date.now(),description:desc,items:[],total:0}; tableOrder.subOrders.push(sub); }

  const price = menuItems[type].find(m=>m.item===itemName)?.price||0;
  sub.items.push({id:'ITEM-'+Date.now(),item:itemName,price,qty,status:'pending'});
  sub.total=sub.items.reduce((s,i)=>s+s.price*i.qty,0);

  await saveTables();
  quantityInput.value='1'; descriptionInput.value='';
});

// Render tables
function renderTables(){
  tablesContainer.innerHTML='';
  Object.values(tables).forEach(table=>{
    if(table.status==='closed') return;
    const box=document.createElement('div'); box.className='table-box';
    const title=document.createElement('h3'); title.textContent='Table '+table.table; box.appendChild(title);

    table.subOrders.forEach(sub=>{
      const pbox=document.createElement('div'); pbox.className='person-box';
      const pname=document.createElement('strong'); pname.textContent=sub.description; pbox.appendChild(pname);
      sub.items.forEach(item=>{
        const ibox=document.createElement('div'); ibox.className='item-box '+item.status;
        ibox.textContent=item.item+' x'+item.qty+' - '+item.price*item.qty+' mts';
        const serveBtn=document.createElement('button'); serveBtn.className='small'; serveBtn.textContent='Serve';
        serveBtn.onclick=async()=>{ item.status='served'; await saveTables(); renderTables(); };
        const cancelBtn=document.createElement('button'); cancelBtn.className='small'; cancelBtn.textContent='Cancel';
        cancelBtn.onclick=async()=>{ sub.items=sub.items.filter(x=>x.id!==item.id); sub.total=sub.items.reduce((s,i)=>s+s.price*i.qty,0); await saveTables(); renderTables(); };
        ibox.appendChild(serveBtn); ibox.appendChild(cancelBtn);
        pbox.appendChild(ibox);
      });
      const payBtn=document.createElement('button'); payBtn.className='add-btn'; payBtn.textContent='Pay'; payBtn.onclick=()=>openPayment(table.id,sub.id);
      pbox.appendChild(payBtn);
      box.appendChild(pbox);
    });

    const payTableBtn=document.createElement('button'); payTableBtn.className='add-btn'; payTableBtn.textContent='Pay Table';
    payTableBtn.onclick=()=>openPayment(table.id,null);
    box.appendChild(payTableBtn);
    tablesContainer.appendChild(box);
  });
}

// Payment
function openPayment(tableID,subID){
  currentPayment={tableID,subID};
  paymentOverlay.style.display='flex';
  paymentContent.innerHTML='';
  const t=tables[tableID];
  if(subID){
    const sub=t.subOrders.find(s=>s.id===subID);
    sub.items.forEach(it=>{ const d=document.createElement('div'); d.textContent=it.item+' x'+it.qty+' - '+it.price*it.qty+' mts'; paymentContent.appendChild(d); });
  }else{
    t.subOrders.forEach(sub=>sub.items.forEach(it=>{ const d=document.createElement('div'); d.textContent=it.item+' x'+it.qty+' - '+it.price*it.qty+' mts'; paymentContent.appendChild(d); }));
  }
}

paidBtn.onclick=async()=>{
  const {tableID,subID}=currentPayment||{};
  if(!tableID||!paymentMethod.value) return alert('Select payment method');
  const t=tables[tableID];
  if(subID){
    const sub=t.subOrders.find(s=>s.id===subID); sub.items.forEach(i=>i.status='paid');
  }else{
    t.subOrders.forEach(sub=>sub.items.forEach(i=>i.status='paid'));
    t.status='closed';
  }
  await saveTables(); renderTables(); paymentOverlay.style.display='none';
};
closePayment.onclick=()=>paymentOverlay.style.display='none';

</script>
</body>
</html>
