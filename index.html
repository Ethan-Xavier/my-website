<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Waiter POS â€” Payment</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
  :root{--primary:#0062ca;--green:#28a745;--muted:#f4f4f4}
  body{font-family:Segoe UI, Tahoma, Geneva, Verdana, sans-serif;background:var(--muted);padding:18px;display:flex;flex-direction:column;align-items:center;gap:12px}
  .order-box{background:var(--primary);padding:18px;border-radius:12px;color:#fff;width:380px;box-shadow:0 8px 24px rgba(0,0,0,.12)}
  .order-box h2{margin:0 0 10px;font-size:18px;text-align:center}
  input,select{width:100%;padding:9px;margin:6px 0;border-radius:8px;border:none;font-size:15px;outline:none}
  .add-btn{background:var(--green);color:#fff;border-radius:8px;padding:10px;font-weight:700;cursor:pointer;border:none}
  .tables-container{display:flex;flex-wrap:wrap;gap:14px;justify-content:center;width:100%}
  .table-box{background:#fff;padding:12px;border-radius:12px;width:340px;box-shadow:0 8px 20px rgba(0,0,0,.12);max-height:640px;overflow:auto;position:relative}
  .table-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .table-total{font-weight:700}
  .person-box{background:#f0f0f0;padding:8px;border-radius:10px;margin-bottom:8px}
  .person-actions{display:flex;gap:6px;margin-top:6px;flex-wrap:wrap}
  .item-box{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;margin:6px 0;background:#fff}
  .pending{background:#fff7e6}
  .served{background:#e9f7ee}
  button.small{padding:6px 8px;border-radius:8px;border:none;cursor:pointer}
  .served-btn{background:var(--green);color:#fff}
  .cancel-btn{background:#dc3545;color:#fff}
  .merge-btn{background:#007bff;color:#fff}
  .split-btn{background:#ffc107;color:#222}
  .move-select{padding:6px;border-radius:6px}
  .controls-row{display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap}
  /* Modal */
  .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:1000}
  .modal{background:#fff;padding:20px;border-radius:12px;width:90%;max-width:400px;max-height:80%;overflow:auto;position:relative}
  .modal h3{margin-top:0;text-align:center}
  .close-modal{position:absolute;top:8px;right:12px;font-size:18px;cursor:pointer}
  @media(max-width:760px){ .order-box,.table-box{width:92%} .tables-container{flex-direction:column;align-items:center} }
</style>
</head>
<body>

<div class="order-box">
  <h2><i class="fas fa-utensils"></i> Waiter POS</h2>

  <label>Table</label>
  <select id="tableSelect"><option value="" disabled selected>Select table</option></select>

  <label>Description (person / note)</label>
  <input id="description" placeholder="e.g. John / Veggie" />

  <label>Type</label>
  <select id="typeSelect"><option value="" disabled selected>Select type</option><option value="food">Food</option><option value="drink">Drink</option></select>

  <label>Item</label>
  <select id="itemSelect"><option value="" disabled selected>Select item</option></select>

  <label>Quantity</label>
  <input id="quantity" type="number" min="1" value="1" />

  <div style="display:flex;gap:8px;align-items:center">
    <button id="addItemBtn" class="add-btn"><i class="fas fa-plus"></i> Add Item</button>
  </div>

  <div class="note">Serve buttons disappear when clicked. Pay tables/sub-orders via modal.</div>
</div>

<div id="tablesContainer" class="tables-container"></div>

<!-- Payment modal -->
<div id="paymentModal" class="modal-overlay">
  <div class="modal">
    <span class="close-modal">&times;</span>
    <h3>Pay Table</h3>
    <div id="paymentContent"></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getFirestore, doc, setDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC6VdctOXcT-qHaLJs1gEzwzVv5AdK5e0w",
  authDomain: "pos-system-9a056.firebaseapp.com",
  projectId: "pos-system-9a056",
  storageBucket: "pos-system-9a056.firebasestorage.app",
  messagingSenderId: "701001104012",
  appId: "1:701001104012:web:294967faec11a627c819a9"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* -------------------------
   UI elements
------------------------- */
const tableSelect = document.getElementById('tableSelect');
const typeSelect = document.getElementById('typeSelect');
const itemSelect = document.getElementById('itemSelect');
const quantityInput = document.getElementById('quantity');
const descriptionInput = document.getElementById('description');
const addItemBtn = document.getElementById('addItemBtn');
const tablesContainer = document.getElementById('tablesContainer');
const paymentModal = document.getElementById('paymentModal');
const paymentContent = document.getElementById('paymentContent');
const closeModal = paymentModal.querySelector('.close-modal');

/* -------------------------
   Menu items
------------------------- */
const menuItems = {
  food: [{item:'Pizza',price:[500]},{item:'Burger',price:[300]},{item:'Pasta',price:[400]}],
  drink: [{item:'Coke',price:[50]},{item:'Water',price:[30]},{item:'Beer',price:[100]}]
};

/* -------------------------
   Local state
------------------------- */
let tables = {}; 

/* -------------------------
   Firestore refs
------------------------- */
const tablesDocRef = doc(db,'posData','tables');

/* -------------------------
   Init table doc if missing
------------------------- */
(async function initIfEmpty(){
  const tSnap = await getDoc(tablesDocRef);
  if(!tSnap.exists()) await setDoc(tablesDocRef, { tables: {} });
})();

/* -------------------------
   Subscribe to tables
------------------------- */
onSnapshot(tablesDocRef, snap=>{
  const data = snap.data();
  tables = (data && data.tables) ? data.tables : {};
  renderTables();
});

/* -------------------------
   Helpers: save
------------------------- */
async function saveTablesToFirebase(){
  // cleanup empty subOrders
  for(const key in tables){
    if(!tables[key].subOrders || tables[key].subOrders.length===0) delete tables[key];
  }
  await setDoc(tablesDocRef, { tables });
}

/* -------------------------
   Populate table select (1..13)
------------------------- */
for(let i=1;i<=13;i++){
  const opt = document.createElement('option'); opt.value=i; opt.textContent=i;
  tableSelect.appendChild(opt);
}

/* -------------------------
   Type -> Item population
------------------------- */
typeSelect.addEventListener('change', ()=>{
  itemSelect.innerHTML = '<option value="" disabled selected>Select item</option>';
  const arr = menuItems[typeSelect.value] || [];
  arr.forEach(m=>{
    const opt = document.createElement('option'); opt.value=m.item; opt.textContent=m.item;
    itemSelect.appendChild(opt);
  });
});

/* -------------------------
   Add item
------------------------- */
addItemBtn.addEventListener('click', async ()=>{
  const tableNum = tableSelect.value;
  const type = typeSelect.value;
  const itemName = itemSelect.value;
  const qty = parseInt(quantityInput.value)||1;
  const desc = (descriptionInput.value || 'Person').trim();

  if(!tableNum || !type || !itemName){ alert('Select table, type, item'); return; }

  // find or create table
  let tableID = Object.keys(tables).find(id => tables[id].table==tableNum && tables[id].tableStatus==='opened');
  if(!tableID){
    tableID = 'TABLE-'+Date.now();
    tables[tableID] = { id: tableID, table: tableNum, tableStatus:'opened', subOrders: [] };
  }
  const tableOrder = tables[tableID];

  // find or create sub-order
  let sub = tableOrder.subOrders.find(s => s.description===desc);
  if(!sub){
    sub = { personID: 'PERSON-'+Date.now(), description: desc, items: [], totalPrice: 0, paymentStatus:'unpaid', paymentMethod:'' };
    tableOrder.subOrders.push(sub);
  }

  // push item
  const price = menuItems[type].find(m=>m.item===itemName).price[0];
  const newItem = { id:'ITEM-'+Date.now(), item:itemName, price, quantity:qty, status:'pending' };
  sub.items.push(newItem);
  sub.totalPrice = sub.items.reduce((s,i)=>s+i.price*i.quantity,0);

  await saveTablesToFirebase();
  quantityInput.value = 1;
  descriptionInput.value = '';
});

/* -------------------------
   Render tables
------------------------- */
function renderTables(){
  tablesContainer.innerHTML = '';
  Object.values(tables).filter(t=>t.tableStatus==='opened').forEach(tableOrder=>{
    const box = document.createElement('div'); box.className='table-box';
    const total = tableOrder.subOrders.reduce((s,sub)=>s + (sub.totalPrice||0),0);
    box.innerHTML = `<div class="table-head"><div><strong>Table ${tableOrder.table}</strong></div><div class="table-total">${total} mts</div></div>`;

    // Pay table button
    const payBtn = document.createElement('button'); payBtn.className='small'; payBtn.textContent='Pay Table';
    payBtn.addEventListener('click', ()=> openPaymentModal(tableOrder.id));
    box.appendChild(payBtn);

    tableOrder.subOrders.forEach(sub=>{
      const p = document.createElement('div'); p.className='person-box';
      p.innerHTML = `<div style="display:flex;justify-content:space-between"><strong>${sub.description}</strong><span>${sub.totalPrice} mts</span></div>`;

      // Items
      sub.items.forEach(it=>{
        const itemDiv = document.createElement('div');
        itemDiv.className='item-box '+(it.status==='pending'?'pending':'served');
        itemDiv.innerHTML = `<div><strong>${it.item} x${it.quantity}</strong><div style="font-size:13px;color:#555">[${it.status}]</div></div>
          <div style="text-align:right"><div style="font-weight:700">${it.price*it.quantity} mts</div>
          <div style="margin-top:6px">${it.status==='pending'?'<button class="served-btn small">Served</button>':''}</div></div>`;

        if(it.status==='pending'){
          itemDiv.querySelector('.served-btn').addEventListener('click', async ()=>{
            it.status='served';
            await saveTablesToFirebase();
          });
        }

        p.appendChild(itemDiv);
      });

      box.appendChild(p);
    });

    tablesContainer.appendChild(box);
  });
}

/* -------------------------
   Payment modal
------------------------- */
function openPaymentModal(tableID){
  const tableOrder = tables[tableID];
  paymentContent.innerHTML = '';
  tableOrder.subOrders.forEach((sub,idx)=>{
    const div = document.createElement('div');
    div.style.border='1px solid #ccc'; div.style.padding='8px'; div.style.margin='6px 0';
    div.innerHTML = `<strong>${sub.description} - ${sub.totalPrice} mts</strong>
      <select class="payment-method">
        <option value="" disabled selected>Payment method</option>
        <option value="Mobile">Mobile</option>
        <option value="Card">Card</option>
        <option value="Cash">Cash</option>
      </select>
      <button class="paid-btn small">Paid</button>`;
    const paidBtn = div.querySelector('.paid-btn');
    const methodSelect = div.querySelector('.payment-method');
    paidBtn.addEventListener('click', async ()=>{
      if(!methodSelect.value){ alert('Choose payment method'); return; }
      sub.paymentStatus='paid';
      sub.paymentMethod = methodSelect.value;
      await saveTablesToFirebase();
      renderTables();
    });
    paymentContent.appendChild(div);
  });
  paymentModal.style.display='flex';
}

closeModal.addEventListener('click', ()=> paymentModal.style.display='none');
window.addEventListener('click', e=>{ if(e.target===paymentModal) paymentModal.style.display='none'; });

</script>
</body>
</html>
