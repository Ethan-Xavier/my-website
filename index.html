<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Waiter POS â€” Efficient</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
:root{--primary:#0062ca;--green:#28a745;--muted:#f4f4f4}
body{font-family:Segoe UI,Tahoma,Geneva,Verdana,sans-serif;background:var(--muted);padding:18px;display:flex;flex-direction:column;align-items:center;gap:12px}
.order-box{background:var(--primary);padding:18px;border-radius:12px;color:#fff;width:380px;box-shadow:0 8px 24px rgba(0,0,0,.12)}
.order-box h2{margin:0 0 10px;font-size:18px;text-align:center}
input,select{width:100%;padding:9px;margin:6px 0;border-radius:8px;border:none;font-size:15px;outline:none}
.add-btn{background:var(--green);color:#fff;border-radius:8px;padding:10px;font-weight:700;cursor:pointer;border:none}
.tables-container{display:flex;flex-wrap:wrap;gap:14px;justify-content:center;width:100%}
.table-box{background:#fff;padding:12px;border-radius:12px;width:340px;box-shadow:0 8px 20px rgba(0,0,0,.12);max-height:640px;overflow:auto}
.table-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.table-total{font-weight:700}
.person-box{background:#f0f0f0;padding:8px;border-radius:10px;margin-bottom:8px}
.person-actions{display:flex;gap:6px;margin-top:6px;flex-wrap:wrap}
.item-box{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;margin:6px 0;background:#fff}
.pending{background:#fff7e6}
.served{background:#e9f7ee}
.paid{background:#d4edda}
button.small{padding:6px 8px;border-radius:8px;border:none;cursor:pointer}
.served-btn{background:var(--green);color:#fff}
.cancel-btn{background:#dc3545;color:#fff}
.merge-btn{background:#007bff;color:#fff}
.split-btn{background:#ffc107;color:#222}
.move-select{padding:6px;border-radius:6px}
.controls-row{display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap}
.modal-bg{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:none;justify-content:center;align-items:center;z-index:10}
.modal{background:#fff;padding:20px;border-radius:12px;width:320px;max-height:80%;overflow:auto;display:flex;flex-direction:column;gap:12px}
.modal h3{margin:0;text-align:center}
.modal button{cursor:pointer}
@media(max-width:760px){.order-box,.table-box{width:92%}.tables-container{flex-direction:column;align-items:center}}
</style>
</head>
<body>

<div class="order-box">
<h2><i class="fas fa-utensils"></i> Waiter POS</h2>
<label>Table</label>
<select id="tableSelect"><option value="" disabled selected>Select table</option></select>
<label>Description</label>
<input id="description" placeholder="e.g. John / Veggie" />
<label>Type</label>
<select id="typeSelect"><option value="" disabled selected>Select type</option><option value="food">Food</option><option value="drink">Drink</option></select>
<label>Item</label>
<select id="itemSelect"><option value="" disabled selected>Select item</option></select>
<select id="priceSelect" style="display:none"></select>
<label>Quantity</label>
<input id="quantity" type="number" min="1" value="1" />
<div style="display:flex;gap:8px;align-items:center">
<button id="addItemBtn" class="add-btn"><i class="fas fa-plus"></i> Add Item</button>
</div>
</div>

<div id="tablesContainer" class="tables-container"></div>

<!-- Payment Modal -->
<div id="paymentModal" class="modal-bg">
<div class="modal">
<h3>Payment</h3>
<div id="paymentContent"></div>
<label>Method</label>
<select id="paymentMethod">
<option value="" disabled selected>Select method</option>
<option value="cash">Cash</option>
<option value="card">Card</option>
<option value="mobile">Mobile</option>
</select>
<button id="payBtn" style="background:var(--green);color:#fff">Paid</button>
<button id="closeModalBtn">Close</button>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getFirestore, doc, setDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

// ======= Firebase Config =======
const firebaseConfig = {
  apiKey: "AIzaSyC6VdctOXcT-qHaLJs1gEzwzVv5AdK5e0w",
  authDomain: "pos-system-9a056.firebaseapp.com",
  projectId: "pos-system-9a056",
  storageBucket: "pos-system-9a056.appspot.com",
  messagingSenderId: "701001104012",
  appId: "1:701001104012:web:294967faec11a627c819a9"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ======= DOM Elements =======
const tableSelect = document.getElementById('tableSelect');
const typeSelect = document.getElementById('typeSelect');
const itemSelect = document.getElementById('itemSelect');
const priceSelect = document.getElementById('priceSelect');
const quantityInput = document.getElementById('quantity');
const descriptionInput = document.getElementById('description');
const addItemBtn = document.getElementById('addItemBtn');
const tablesContainer = document.getElementById('tablesContainer');

const paymentModal = document.getElementById('paymentModal');
const paymentContent = document.getElementById('paymentContent');
const paymentMethod = document.getElementById('paymentMethod');
const payBtn = document.getElementById('payBtn');
const closeModalBtn = document.getElementById('closeModalBtn');

// ======= Menu =======
const menuItems = {
  food: [
    { item: 'Pizza', price: [500] },
    { item: 'Pasta', price: [300] },
    { item: 'Burger', price: [200] }
  ],
  drink: [
    { item: 'Soda', price: [50] },
    { item: 'Juice', price: [80] },
    { item: 'Water', price: [30] }
  ]
};

// ======= Initialize Tables =======
let tablesData = { openTables: [], closedTables: [] };
const posDocRef = doc(db, 'posData', 'tables');

// Fill table numbers
for(let i=1;i<=13;i++){
  const opt=document.createElement('option'); opt.value=i; opt.textContent=i;
  tableSelect.appendChild(opt);
}

// ======= Firestore Sync =======
async function saveTables() {
  await setDoc(posDocRef, tablesData);
}

onSnapshot(posDocRef, snap => {
  const data = snap.data();
  if (data) tablesData = data;
  renderTables();
});

// ======= Type/Item select =======
typeSelect.addEventListener('change',()=>{
  itemSelect.innerHTML='<option value="" disabled selected>Select item</option>';
  (menuItems[typeSelect.value]||[]).forEach(m=>{
    const opt=document.createElement('option'); opt.value=m.item; opt.textContent=m.item;
    itemSelect.appendChild(opt);
  });
  priceSelect.style.display='none';
});

itemSelect.addEventListener('change',()=>{
  const menuItem=(menuItems[typeSelect.value]||[]).find(m=>m.item===itemSelect.value);
  if(menuItem && menuItem.price.length>1){
    priceSelect.innerHTML='<option value="" disabled selected>Select price</option>';
    menuItem.price.forEach(p=>{
      const opt=document.createElement('option'); opt.value=p; opt.textContent=p+' mts';
      priceSelect.appendChild(opt);
    });
    priceSelect.style.display='block';
  } else priceSelect.style.display='none';
});

// ======= Add Item =======
addItemBtn.addEventListener('click', async()=>{
  const tableNumber = tableSelect.value;
  const type = typeSelect.value;
  const itemName = itemSelect.value;
  const price = priceSelect.style.display==='block' ? parseInt(priceSelect.value) : (menuItems[type]||[]).find(m=>m.item===itemName)?.price[0];
  const qty = parseInt(quantityInput.value) || 1;
  const desc = (descriptionInput.value||'Order').trim();
  if(!tableNumber||!type||!itemName||!price||qty<1){alert('Select Table, Type, Item and Quantity'); return;}

  // Find table
  let table = tablesData.openTables.find(t=>t.tableNumber==tableNumber);
  if(!table){
    table={ tableNumber, timeOpened:new Date().toISOString(), people:[], totalPrice:0, merged:false };
    tablesData.openTables.push(table);
  }

  // Find person
  let person = table.people.find(p=>p.description===desc);
  if(!person){ person={ description:desc, orders:[], paid:false }; table.people.push(person); }

  // Add order
  person.orders.push({ item:itemName, type, price, quantity:qty, status:'pending', time:new Date().toISOString() });

  // Recalculate totals
  table.totalPrice = table.people.reduce((s,p)=>s+p.orders.reduce((sum,o)=>sum+o.price*o.quantity,0),0);

  await saveTables();
  quantityInput.value=1; descriptionInput.value='';
  renderTables();
});

// ======= Render Tables =======
function renderTables(){
  tablesContainer.innerHTML='';
  tablesData.openTables.forEach(table=>{
    const box=document.createElement('div'); box.className='table-box';
    box.innerHTML=`<div class="table-head">
      <div><strong>Table ${table.tableNumber}</strong></div>
      <div class="table-total">${table.totalPrice} mts</div>
    </div>`;

    // Merge/Split buttons
    const controls=document.createElement('div'); controls.className='controls-row';
    if(!table.merged && tablesData.openTables.length>1){
      const mergeBtn=document.createElement('button'); mergeBtn.className='merge-btn small'; mergeBtn.textContent='Merge Table';
      mergeBtn.onclick=()=>mergeTables(table);
      controls.appendChild(mergeBtn);
    }
    if(table.merged){
      const splitBtn=document.createElement('button'); splitBtn.className='split-btn small'; splitBtn.textContent='Split Table';
      splitBtn.onclick=()=>splitTable(table);
      controls.appendChild(splitBtn);
    }
    box.appendChild(controls);

    // Render people
    table.people.forEach(person=>{
      const pDiv=document.createElement('div'); pDiv.className='person-box';
      pDiv.innerHTML=`<strong>${person.description}</strong>`;
      // Orders
      person.orders.forEach((o,i)=>{
        const orderDiv=document.createElement('div'); orderDiv.className='item-box '+o.status;
        orderDiv.innerHTML=`${o.quantity}x ${o.item} (${o.type}) - ${o.price*o.quantity} mts
          <div class="person-actions">
            ${o.status!=='served'?'<button class="served-btn small">Serve</button>':''}
            <button class="cancel-btn small">Cancel</button>
          </div>`;
        pDiv.appendChild(orderDiv);
        // Serve
        if(o.status!=='served') orderDiv.querySelector('.served-btn').onclick=async()=>{
          o.status='served'; await saveTables(); renderTables();
        };
        // Cancel
        orderDiv.querySelector('.cancel-btn').onclick=async()=>{
          person.orders.splice(i,1);
          if(person.orders.length===0) table.people = table.people.filter(p=>p!==person);
          table.totalPrice = table.people.reduce((s,p)=>s+p.orders.reduce((sum,o)=>sum+o.price*o.quantity,0),0);
          if(table.people.length===0) tablesData.openTables = tablesData.openTables.filter(t=>t!==table);
          await saveTables(); renderTables();
        };
      });

      // Payment per person
      const payBtnPerson=document.createElement('button'); payBtnPerson.className='add-btn small'; payBtnPerson.textContent='Pay';
      payBtnPerson.onclick=()=>showPayment(table, person);
      pDiv.appendChild(payBtnPerson);

      box.appendChild(pDiv);
    });

    tablesContainer.appendChild(box);
  });
}

// ======= Merge/Split Logic =======
async function mergeTables(targetTable){
  const mergedPeople = tablesData.openTables.reduce((arr,t)=>arr.concat(t.people),[]);
  targetTable.people = [{ description: mergedPeople.map(p=>p.description).join(' + '), orders: mergedPeople.flatMap(p=>p.orders), paid:false }];
  targetTable.merged=true;
  tablesData.openTables = [targetTable];
  targetTable.totalPrice = targetTable.people[0].orders.reduce((s,o)=>s+o.price*o.quantity,0);
  await saveTables(); renderTables();
}

async function splitTable(table){
  table.merged=false;
  // After split, create individual tables for each original person
  const newTables = table.people.map(p=>{
    return { tableNumber: table.tableNumber, timeOpened:new Date().toISOString(), people:[p], totalPrice:p.orders.reduce((s,o)=>s+o.price*o.quantity,0), merged:false };
  });
  tablesData.openTables = tablesData.openTables.concat(newTables.filter(t=>t!==table));
  tablesData.openTables = tablesData.openTables.filter(t=>t!==table);
  await saveTables(); renderTables();
}

// ======= Payment =======
function showPayment(table, person){
  paymentModal.style.display='flex';
  paymentContent.innerHTML=`<div><strong>${person.description}</strong> - ${person.orders.reduce((s,o)=>s+o.price*o.quantity,0)} mts</div>`;
  payBtn.onclick=async()=>{
    const method=paymentMethod.value;
    if(!method){ alert('Select payment method'); return; }
    person.paid=true; person.orders.forEach(o=>o.status='served');
    table.people = table.people.filter(p=>!p.paid);
    if(table.people.length===0) tablesData.openTables = tablesData.openTables.filter(t=>t!==table);
    await saveTables(); paymentModal.style.display='none'; renderTables();
  };
  closeModalBtn.onclick=()=>{ paymentModal.style.display='none'; };
}

</script>
</body>
</html>
